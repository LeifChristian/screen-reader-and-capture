<!DOCTYPE html>
<html>
  <head>
    <title>Screen Narrator - Setup</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100vh;
        overflow: hidden;
      }

      .modal {
        background: white;
        border-radius: 12px;
        box-shadow: 0 24px 38px rgba(0, 0, 0, 0.14),
          0 9px 46px rgba(0, 0, 0, 0.12), 0 11px 15px rgba(0, 0, 0, 0.2);
        width: 500px;
        max-width: 90vw;
        max-height: 90vh;
        padding: 0;
        animation: modalSlideIn 0.3s ease-out;
        display: flex;
        flex-direction: column;
      }

      @keyframes modalSlideIn {
        from {
          opacity: 0;
          transform: translateY(-50px) scale(0.9);
        }
        to {
          opacity: 1;
          transform: translateY(0) scale(1);
        }
      }

      .modal-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 24px;
        border-radius: 12px 12px 0 0;
        text-align: center;
        flex-shrink: 0;
        position: relative;
      }

      .modal-header h2 {
        font-size: 24px;
        font-weight: 500;
        margin-bottom: 8px;
      }

      .modal-header p {
        opacity: 0.9;
        font-size: 14px;
      }

      .close-button {
        position: absolute;
        top: 16px;
        right: 20px;
        background: none;
        border: none;
        color: white;
        font-size: 24px;
        font-weight: bold;
        cursor: pointer;
        padding: 4px 8px;
        border-radius: 4px;
        transition: all 0.2s ease;
        opacity: 0.7;
      }

      .close-button:hover {
        opacity: 1;
        background: rgba(255, 255, 255, 0.1);
      }

      .modal-body {
        padding: 32px 24px;
        flex: 1;
        overflow-y: auto;
        max-height: 400px;
      }

      .mode-selection {
        display: flex;
        flex-direction: column;
        gap: 16px;
        margin-bottom: 24px;
      }

      .mode-card {
        border: 2px solid #e0e0e0;
        border-radius: 8px;
        padding: 20px;
        cursor: pointer;
        transition: all 0.2s ease;
        position: relative;
      }

      .mode-card:hover {
        border-color: #667eea;
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.15);
      }

      .mode-card.selected {
        border-color: #667eea;
        background: rgba(102, 126, 234, 0.05);
      }

      .mode-card .radio {
        position: absolute;
        top: 16px;
        right: 16px;
        width: 20px;
        height: 20px;
        border: 2px solid #ccc;
        border-radius: 50%;
        background: white;
      }

      .mode-card.selected .radio {
        border-color: #667eea;
      }

      .mode-card.selected .radio::after {
        content: "";
        position: absolute;
        top: 50%;
        left: 50%;
        width: 10px;
        height: 10px;
        background: #667eea;
        border-radius: 50%;
        transform: translate(-50%, -50%);
      }

      .mode-title {
        font-size: 18px;
        font-weight: 600;
        color: #333;
        margin-bottom: 8px;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .mode-description {
        color: #666;
        font-size: 14px;
        line-height: 1.5;
      }

      .notification-prompt {
        display: none;
        margin-top: 16px;
        padding: 16px;
        background: #f8f9fa;
        border-radius: 8px;
        border-left: 4px solid #667eea;
      }

      .notification-prompt.show {
        display: block;
      }

      .form-group {
        margin-bottom: 16px;
      }

      .form-group label {
        display: block;
        font-weight: 500;
        color: #333;
        margin-bottom: 8px;
      }

      .form-group textarea {
        width: 100%;
        padding: 12px;
        border: 2px solid #e0e0e0;
        border-radius: 6px;
        font-family: inherit;
        font-size: 14px;
        resize: vertical;
        min-height: 80px;
        max-height: 120px;
        transition: border-color 0.2s ease;
        overflow-y: auto;
      }

      .form-group textarea:focus {
        outline: none;
        border-color: #667eea;
      }

      .form-group .hint {
        font-size: 12px;
        color: #666;
        margin-top: 4px;
      }

      .modal-footer {
        padding: 16px 24px;
        border-top: 1px solid #e0e0e0;
        display: flex;
        justify-content: flex-end;
        gap: 12px;
        flex-shrink: 0;
      }

      .btn {
        padding: 12px 24px;
        border: none;
        border-radius: 6px;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s ease;
        min-width: 80px;
      }

      .btn-secondary {
        background: #f5f5f5;
        color: #666;
      }

      .btn-secondary:hover {
        background: #e0e0e0;
      }

      .btn-primary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
      }

      .btn-primary:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
      }

      .btn-primary:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
      }

      .example-prompts {
        margin-top: 12px;
        padding: 12px;
        background: #e8f4fd;
        border-radius: 6px;
        border-left: 4px solid #2196f3;
        max-height: 120px;
        overflow-y: auto;
      }

      .example-prompts h4 {
        font-size: 13px;
        color: #1976d2;
        margin-bottom: 8px;
      }

      .example-prompts ul {
        list-style: none;
        font-size: 12px;
        color: #666;
      }

      .example-prompts li {
        margin-bottom: 4px;
        padding-left: 16px;
        position: relative;
      }

      .example-prompts li::before {
        content: "‚Ä¢";
        position: absolute;
        left: 0;
        color: #2196f3;
      }

      .region-selection {
        margin-top: 24px;
        padding: 16px;
        background: #f8f9fa;
        border-radius: 8px;
        border: 1px solid #e0e0e0;
      }

      .region-selection h4 {
        font-size: 16px;
        font-weight: 600;
        color: #333;
        margin-bottom: 12px;
      }

      .region-btn {
        padding: 10px 16px;
        border: 1px solid #ccc;
        border-radius: 6px;
        background: #fff;
        cursor: pointer;
        transition: all 0.2s ease;
        font-size: 14px;
        font-weight: 500;
        color: #333;
      }

      .region-btn:hover {
        border-color: #667eea;
        color: #667eea;
      }

      .region-btn.selected {
        border-color: #667eea;
        background: rgba(102, 126, 234, 0.1);
        color: #667eea;
      }

      .region-info {
        font-size: 12px;
        color: #666;
        margin-top: 8px;
      }
    </style>
  </head>
  <body>
    <div class="modal">
      <div class="modal-header">
        <h2>üéôÔ∏è Screen Narrator Setup</h2>
        <p>Choose your monitoring mode to get started</p>
        <button class="close-button" onclick="closeModal()" title="Close">
          √ó
        </button>
      </div>

      <div class="modal-body">
        <div class="mode-selection">
          <div
            class="mode-card"
            data-mode="checkin"
            onclick="selectMode('checkin')"
          >
            <div class="radio"></div>
            <div class="mode-title">üîÑ Check-in Mode</div>
            <div class="mode-description">
              Continuously narrates what's on your screen at regular intervals.
              Perfect for staying aware of your current activity and context.
            </div>
          </div>

          <div
            class="mode-card"
            data-mode="notification"
            onclick="selectMode('notification')"
          >
            <div class="radio"></div>
            <div class="mode-title">üö® Notification Mode</div>
            <div class="mode-description">
              Monitors your screen for specific content you define. Plays an
              alarm and describes what it found when your target appears.
            </div>
          </div>
        </div>

        <div class="region-selection">
          <h4 style="margin-bottom: 12px; color: #333">Screen Capture Area</h4>
          <div style="display: flex; gap: 12px; margin-bottom: 16px">
            <button
              type="button"
              class="region-btn"
              id="fullScreenBtn"
              onclick="selectRegion('fullscreen')"
            >
              üñ•Ô∏è Full Screen
            </button>
            <button
              type="button"
              class="region-btn"
              id="targetRegionBtn"
              onclick="selectRegion('target')"
            >
              üéØ Select Target Region
            </button>
          </div>
          <div class="region-info" id="regionInfo">
            <small>Full screen monitoring selected</small>
          </div>
        </div>

        <div class="notification-prompt" id="notificationPrompt">
          <div class="form-group">
            <label for="searchPrompt">What should I look for?</label>
            <textarea
              id="searchPrompt"
              placeholder="Describe what you want to be notified about..."
              maxlength="200"
            ></textarea>
            <div class="hint">
              Be specific about what you want to detect (e.g., "a queue number
              below 10", "an email from John", "a red error message")
            </div>
          </div>

          <div class="example-prompts">
            <h4>Example Prompts:</h4>
            <ul>
              <li>"A queue number that shows 10 or lower"</li>
              <li>"An email notification from my boss"</li>
              <li>"A red error message or warning dialog"</li>
              <li>"A meeting notification or calendar alert"</li>
              <li>"A stock price that drops below $50"</li>
              <li>"The text WHAM on the screen, any case"</li>
            </ul>
          </div>
        </div>
      </div>

      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="cancelSetup()">
          Cancel
        </button>
        <button
          class="btn btn-primary"
          id="startBtn"
          onclick="startApp()"
          disabled
        >
          Start Monitoring
        </button>
      </div>
    </div>

    <script>
      const { ipcRenderer } = require("electron");

      let selectedMode = null;
      let selectedRegion = "fullscreen"; // Default to full screen

      // Load last used settings
      async function loadLastUsedSettings() {
        try {
          const result = await ipcRenderer.invoke("get-user-settings");
          if (result.success) {
            const lastMode = result.settings.lastUsedMode || "checkin";
            const lastRegion = result.settings.lastUsedRegion;

            // Set last used mode as default
            selectMode(lastMode);

            // Set region based on last used
            if (lastRegion) {
              selectRegion("target");
            } else {
              selectRegion("fullscreen");
            }
          }
        } catch (error) {
          console.error("Error loading last used settings:", error);
          // Fall back to defaults
          selectMode("checkin");
          selectRegion("fullscreen");
        }
      }

      function selectMode(mode) {
        selectedMode = mode;

        // Update UI
        document.querySelectorAll(".mode-card").forEach((card) => {
          card.classList.remove("selected");
        });
        document
          .querySelector(`[data-mode="${mode}"]`)
          .classList.add("selected");

        // Show/hide notification prompt
        const notificationPrompt =
          document.getElementById("notificationPrompt");
        if (mode === "notification") {
          notificationPrompt.classList.add("show");
        } else {
          notificationPrompt.classList.remove("show");
        }

        // Enable start button
        updateStartButton();
      }

      function selectRegion(region) {
        selectedRegion = region;

        // Update UI
        document.querySelectorAll(".region-btn").forEach((btn) => {
          btn.classList.remove("selected");
        });

        if (region === "fullscreen") {
          document.getElementById("fullScreenBtn").classList.add("selected");
        } else {
          document.getElementById("targetRegionBtn").classList.add("selected");
        }

        const regionInfo = document.getElementById("regionInfo");
        if (region === "fullscreen") {
          regionInfo.innerHTML =
            "<small>Full screen monitoring selected</small>";
        } else {
          regionInfo.innerHTML =
            "<small>Target region will be selected after clicking Start Monitoring</small>";
        }

        // For target region selection, if we have a valid configuration, we can start
        updateStartButton();
      }

      function updateStartButton() {
        const startBtn = document.getElementById("startBtn");
        const searchPrompt = document
          .getElementById("searchPrompt")
          .value.trim();

        if (selectedMode === "checkin") {
          // Check-in mode: always ready to start
          startBtn.disabled = false;
        } else if (selectedMode === "notification") {
          // Notification mode: needs search prompt
          startBtn.disabled = searchPrompt.length < 5;
        } else {
          startBtn.disabled = true;
        }
      }

      function startApp() {
        const config = {
          mode: selectedMode,
          regionType: selectedRegion,
          searchPrompt:
            selectedMode === "notification"
              ? document.getElementById("searchPrompt").value.trim()
              : null,
        };

        if (selectedRegion === "target") {
          // Send config first, then trigger region selection
          ipcRenderer.send("start-app-with-region-selection", config);
        } else {
          // Send config for full screen mode
          ipcRenderer.send("start-app-with-config", config);
        }

        // Close modal
        window.close();
      }

      function cancelSetup() {
        ipcRenderer.send("cancel-setup");
        window.close();
      }

      function closeModal() {
        window.close();
      }

      // Listen for search prompt changes
      document
        .getElementById("searchPrompt")
        .addEventListener("input", updateStartButton);

      // Auto-focus and load last used settings
      document.addEventListener("DOMContentLoaded", () => {
        loadLastUsedSettings();
      });

      // Handle escape key
      document.addEventListener("keydown", (e) => {
        if (e.key === "Escape") {
          window.close();
        }
      });
    </script>
  </body>
</html>
